<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MediaTeam Hub v2.0 - Production Ready</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    [v-cloak] { display: none; }
    .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    .glass-morphism { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
<div id="app" v-cloak>
  <nav class="bg-white shadow-md sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-2">
      <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-2 rounded-lg text-white shadow-lg">
        <i data-lucide="shield-check"></i>
      </div>
      <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-700">
        MediaTeam Hub
      </h1>
    </div>

    <div class="flex gap-2 bg-gray-100 p-1 rounded-xl">
      <button
        @click="currentTab = 'report'"
        :class="{'bg-white shadow text-blue-600': currentTab === 'report'}"
        class="px-6 py-2 rounded-lg font-medium transition text-gray-500"
      >
        Báo cáo
      </button>

      <button
        @click="currentTab = 'sellout'"
        :class="{'bg-white shadow text-blue-600': currentTab === 'sellout'}"
        class="px-6 py-2 rounded-lg font-medium transition text-gray-500"
      >
        Sell-out
      </button>

      <button
        @click="checkAdminAccess"
        :class="{'bg-white shadow text-blue-600': currentTab === 'admin'}"
        class="px-6 py-2 rounded-lg font-medium transition text-gray-500"
      >
        Admin
      </button>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-6">

    <!-- REPORT TAB -->
    <div v-if="currentTab === 'report'" class="max-w-xl mx-auto py-10">
      <div class="bg-white rounded-2xl shadow-xl p-8 border border-white overflow-hidden relative">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-indigo-600"></div>
        <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Báo cáo bài đăng mới</h2>
        <p class="text-gray-500 text-center mb-8 text-sm">Vui lòng điền đầy đủ thông tin bài đã đăng</p>

        <form @submit.prevent="submitReport" class="space-y-5">
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2 md:col-span-1">
              <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Họ tên nhân viên</label>

              <div class="space-y-2">
                <select
                  v-model="reportUserSelected"
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition"
                  required
                >
                  <option value="" disabled>Chọn tên...</option>
                  <option v-for="n in employeeNames" :key="'report_'+n" :value="n">{{ n }}</option>
                  <option value="__new__">+ Nhập tên mới...</option>
                </select>

                <input
                  v-if="reportUserSelected === '__new__'"
                  v-model="reportUserNew"
                  type="text"
                  placeholder="Nhập tên mới..."
                  class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition"
                  @blur="commitNewName('report')"
                />
              </div>
            </div>

            <div class="col-span-2 md:col-span-1">
              <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nền tảng</label>
              <select v-model="form.platform"
                      class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                <option value="Facebook">Facebook</option>
                <option value="TikTok">TikTok</option>
                <option value="Instagram">Instagram</option>
                <option value="YouTube">YouTube</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Link bài viết (URL)</label>
            <input v-model="form.link" type="url" required placeholder="https://www.facebook.com/..."
                   class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" />
          </div>

          <button type="submit" :disabled="loading"
                  class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-4 rounded-xl font-bold hover:scale-[1.02] active:scale-[0.98] transition shadow-lg shadow-blue-200 flex justify-center items-center gap-2">
            <span v-if="loading" class="animate-spin text-xl">⏳</span>
            <span v-else>Gửi báo cáo hệ thống</span>
          </button>
        </form>
      </div>
    </div>

    <!-- SELL-OUT TAB -->
    <div v-if="currentTab === 'sellout'" class="space-y-6">

      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-white overflow-hidden relative">
          <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-400 to-teal-600"></div>
          <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Báo cáo Sell-out</h2>
          <p class="text-gray-500 text-center mb-8 text-sm">Nhập số lượng & doanh thu bán ra (VNĐ)</p>

          <form @submit.prevent="submitSale" class="space-y-5">
            <div class="grid grid-cols-2 gap-4">
              <div class="col-span-2 md:col-span-1">
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Họ tên nhân viên</label>

                <div class="space-y-2">
                  <select
                    v-model="selloutUserSelected"
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition"
                    required
                  >
                    <option value="" disabled>Chọn tên...</option>
                    <option v-for="n in employeeNames" :key="'sellout_'+n" :value="n">{{ n }}</option>
                    <option value="__new__">+ Nhập tên mới...</option>
                  </select>

                  <input
                    v-if="selloutUserSelected === '__new__'"
                    v-model="selloutUserNew"
                    type="text"
                    placeholder="Nhập tên mới..."
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition"
                    @blur="commitNewName('sellout')"
                  />
                </div>
              </div>

              <div class="col-span-2 md:col-span-1">
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Team</label>
                <select v-model="saleForm.team"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition">
                  <option value="Sale">Sale</option>
                  <option value="MKT">MKT</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="col-span-2 md:col-span-1">
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Sản phẩm / Dịch vụ</label>
                <input v-model="saleForm.item" type="text" required placeholder="Áo / Dưa hấu / Dịch vụ..."
                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition" />
              </div>
              <div class="col-span-2 md:col-span-1">
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Kênh</label>
                <select v-model="saleForm.channel"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition">
                  <option value="Online">Online</option>
                  <option value="Offline">Offline</option>
                  <option value="Facebook">Facebook</option>
                  <option value="Zalo">Zalo</option>
                  <option value="Khác">Khác</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Số lượng</label>
                <input v-model.number="saleForm.qty" type="number" min="1" required
                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition" />
              </div>
              <div>
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Doanh thu (VNĐ)</label>
                <input v-model.number="saleForm.revenue" type="number" min="0" step="1000" required
                       class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition" />
              </div>
            </div>

            <button type="submit" :disabled="saleLoading"
                    class="w-full bg-gradient-to-r from-emerald-600 to-teal-700 text-white py-4 rounded-xl font-bold hover:scale-[1.02] active:scale-[0.98] transition shadow-lg shadow-emerald-200 flex justify-center items-center gap-2">
              <span v-if="saleLoading" class="animate-spin text-xl">⏳</span>
              <span v-else>Gửi báo cáo Sell-out</span>
            </button>
          </form>
        </div>
      </div>

      <!-- PUBLIC DASHBOARD -->
      <div class="max-w-7xl mx-auto space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs font-bold uppercase">Tổng bản ghi sell-out</p>
            <h3 class="text-2xl font-black text-gray-800">{{ sales.length }}</h3>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs font-bold uppercase">Tổng doanh thu</p>
            <h3 class="text-2xl font-black text-gray-800">{{ formatVND(totalRevenue) }}</h3>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs font-bold uppercase">Tổng số lượng</p>
            <h3 class="text-2xl font-black text-gray-800">{{ totalQty }}</h3>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs font-bold uppercase">Số nhân sự có bán</p>
            <h3 class="text-2xl font-black text-gray-800">{{ ranking.length }}</h3>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-1">
            <div class="flex items-center justify-between mb-4">
              <h4 class="font-bold">Top doanh thu (Bar)</h4>
              <select v-model.number="topN" class="text-xs border rounded-lg px-2 py-1 bg-gray-50">
                <option :value="5">Top 5</option>
                <option :value="10">Top 10</option>
                <option :value="20">Top 20</option>
              </select>
            </div>
            <div class="w-full h-64">
              <canvas id="selloutChart"></canvas>
            </div>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
            <div class="flex justify-between items-center mb-4">
              <h4 class="font-bold">Ranking doanh thu (Sell-out)</h4>
              <button @click="exportSelloutToCSV"
                      class="text-xs bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full border border-emerald-200 font-bold hover:bg-emerald-100">
                Xuất CSV
              </button>
            </div>

            <div class="overflow-x-auto max-h-96">
              <table class="w-full text-left">
                <thead class="sticky top-0 bg-white">
                <tr class="text-gray-400 text-xs uppercase border-b">
                  <th class="pb-3 px-2">#</th>
                  <th class="pb-3 px-2">Nhân viên</th>
                  <th class="pb-3 px-2">Team</th>
                  <th class="pb-3 px-2 text-right">SL</th>
                  <th class="pb-3 px-2 text-right">Doanh thu</th>
                </tr>
                </thead>

                <tbody class="divide-y divide-gray-50">
                <tr v-for="(r, idx) in ranking" :key="r.user + '_' + r.team" class="hover:bg-emerald-50/30 transition">
                  <td class="py-4 px-2 text-sm font-black text-gray-600">{{ idx + 1 }}</td>
                  <td class="py-4 px-2 font-bold text-gray-800 text-sm">{{ r.user }}</td>
                  <td class="py-4 px-2">
                    <span class="text-[10px] font-black px-2 py-0.5 rounded"
                          :class="r.team === 'Sale' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'">
                      {{ r.team }}
                    </span>
                  </td>
                  <td class="py-4 px-2 text-right text-sm font-bold text-gray-700">{{ r.qty }}</td>
                  <td class="py-4 px-2 text-right text-sm font-black text-gray-800">{{ formatVND(r.revenue) }}</td>
                </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-6">
              <h4 class="font-bold mb-3">Lịch sử nhập sell-out (Real-time)</h4>

              <div class="overflow-x-auto max-h-72">
                <table class="w-full text-left">
                  <thead class="sticky top-0 bg-white">
                  <tr class="text-gray-400 text-xs uppercase border-b">
                    <th class="pb-3 px-2">Nhân viên</th>
                    <th class="pb-3 px-2">Item</th>
                    <th class="pb-3 px-2 text-right">SL</th>
                    <th class="pb-3 px-2 text-right">Doanh thu</th>
                    <th class="pb-3 px-2">Kênh</th>
                    <th class="pb-3 px-2">Thời gian</th>
                    <th class="pb-3 px-2 text-right">Xóa</th>
                  </tr>
                  </thead>

                  <tbody class="divide-y divide-gray-50">
                  <tr v-for="s in sales" :key="s.id" class="hover:bg-emerald-50/30 transition">
                    <td class="py-3 px-2 font-bold text-gray-700 text-sm">{{ s.user }}</td>
                    <td class="py-3 px-2 text-sm text-gray-700">{{ s.item }}</td>
                    <td class="py-3 px-2 text-right text-sm font-bold text-gray-700">{{ s.qty }}</td>
                    <td class="py-3 px-2 text-right text-sm font-black text-gray-800">{{ formatVND(s.revenue) }}</td>
                    <td class="py-3 px-2 text-xs text-gray-500">{{ s.channel }}</td>
                    <td class="py-3 px-2 text-gray-400 text-[10px]">{{ formatTime(s.timestamp) }}</td>
                    <td class="py-3 px-2 text-right">
                      <button v-if="isAdmin" @click="deleteSale(s.id)" class="text-red-400 hover:text-red-600 transition p-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                      <span v-else class="text-[10px] text-gray-300">—</span>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

    <!-- ADMIN TAB -->
    <div v-if="currentTab === 'admin' && isAdmin" class="space-y-6 animate-in fade-in duration-500">

      <!-- ADMIN: ANNOUNCEMENT EDITOR -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-700 flex items-center justify-center">
              <i data-lucide="megaphone" class="w-5 h-5"></i>
            </div>
            <div>
              <h3 class="font-black text-gray-800">Thông báo khi vào web</h3>
              <p class="text-xs text-gray-400">
                Người dùng sẽ thấy modal khi có thông báo mới (theo updatedAt).
              </p>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-gray-400 uppercase">Bật thông báo</span>
            <button
              @click="announceEdit.enabled = !announceEdit.enabled"
              class="px-3 py-1 rounded-full text-xs font-black border transition"
              :class="announceEdit.enabled ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : 'bg-gray-50 text-gray-500 border-gray-200'"
            >
              {{ announceEdit.enabled ? 'ON' : 'OFF' }}
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-5">
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Tiêu đề</label>
              <input
                v-model="announceEdit.title"
                type="text"
                placeholder="Ví dụ: Cập nhật chính sách báo cáo / thông báo nghỉ lễ..."
                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>

            <div>
              <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nội dung</label>
              <textarea
                v-model="announceEdit.content"
                rows="7"
                placeholder="- Nội dung 1&#10;- Nội dung 2&#10;* Ghi chú..."
                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
              ></textarea>
              <p class="text-[11px] text-gray-400 mt-1">
                Mẹo: xuống dòng sẽ hiển thị đúng trong modal.
              </p>
            </div>

            <div class="flex gap-2 flex-wrap">
              <button
                @click="saveAnnouncement"
                :disabled="announceSaving"
                class="px-4 py-3 rounded-xl font-black text-white bg-gradient-to-r from-indigo-600 to-blue-600 hover:scale-[1.01] active:scale-[0.99] transition shadow"
              >
                <span v-if="announceSaving" class="inline-flex items-center gap-2">
                  <span class="animate-spin">⏳</span> Đang lưu...
                </span>
                <span v-else class="inline-flex items-center gap-2">
                  <i data-lucide="save" class="w-4 h-4"></i>
                  Lưu thông báo
                </span>
              </button>

              <button
                @click="resetAnnounceEdit"
                class="px-4 py-3 rounded-xl font-black text-gray-600 bg-gray-100 hover:bg-gray-200 transition"
              >
                Reset theo dữ liệu hiện tại
              </button>

              <button
                @click="forceShowAnnouncement"
                class="px-4 py-3 rounded-xl font-black text-indigo-700 bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 transition"
              >
                Xem thử modal
              </button>
            </div>

            <p v-if="announcement.updatedAt" class="text-[11px] text-gray-400">
              Lần cập nhật gần nhất: <span class="font-bold text-gray-600">{{ formatTime(announcement.updatedAt) }}</span>
            </p>
          </div>

          <!-- Preview -->
          <div class="bg-gray-50 border border-gray-200 rounded-2xl p-5">
            <div class="flex items-center justify-between">
              <h4 class="font-black text-gray-800">Preview</h4>
              <span class="text-[10px] font-black px-2 py-1 rounded-full"
                    :class="announceEdit.enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-200 text-gray-600'">
                {{ announceEdit.enabled ? 'Sẽ hiển thị' : 'Đang tắt' }}
              </span>
            </div>

            <div class="mt-4 bg-white rounded-2xl border border-gray-100 p-5">
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-700 flex items-center justify-center shrink-0">
                  <i data-lucide="bell-ring" class="w-5 h-5"></i>
                </div>
                <div class="min-w-0">
                  <div class="font-black text-gray-800">
                    {{ announceEdit.title || 'Thông báo từ Admin' }}
                  </div>
                  <div class="mt-2 text-sm text-gray-600 whitespace-pre-line">
                    {{ announceEdit.content || 'Chưa có nội dung.' }}
                  </div>
                </div>
              </div>
            </div>

            <p class="text-[11px] text-gray-400 mt-3">
              Lưu ý: Modal ngoài trang sẽ tự hiện khi admin “Lưu thông báo” (updatedAt thay đổi).
            </p>
          </div>
        </div>
      </div>

      <!-- stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div v-for="stat in stats" :key="stat.label" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
          <p class="text-gray-400 text-xs font-bold uppercase">{{ stat.label }}</p>
          <h3 class="text-2xl font-black text-gray-800">{{ stat.value }}</h3>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-1 flex flex-col items-center">
          <h4 class="font-bold mb-4 self-start">Tỷ lệ Nền tảng</h4>
          <div class="w-full h-64">
            <canvas id="platformChart"></canvas>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
          <!-- HEADER + SEARCH + EXPORT -->
          <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
            <h4 class="font-bold">Lịch sử báo cáo (Real-time)</h4>

            <!-- SEARCH BY USER -->
            <div class="flex-1 md:max-w-xs">
              <div class="relative">
                <input
                  v-model="searchUser"
                  type="text"
                  placeholder="Tìm theo tên nhân viên..."
                  class="w-full pl-10 pr-3 py-2 text-sm border rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500"
                />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                  <i data-lucide="search" class="w-4 h-4"></i>
                </span>
              </div>
              <p v-if="searchUser" class="text-[11px] text-gray-400 mt-1">
                Đang lọc: <span class="font-bold text-gray-600">{{ filteredPosts.length }}</span> kết quả
              </p>
            </div>

            <button @click="exportToCSV"
                    class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full border border-green-200 font-bold hover:bg-green-100 self-start md:self-auto">
              Xuất CSV
            </button>
          </div>

          <div class="overflow-x-auto max-h-96">
            <table class="w-full text-left">
              <thead class="sticky top-0 bg-white">
              <tr class="text-gray-400 text-xs uppercase border-b">
                <th class="pb-3 px-2">Nhân viên</th>
                <th class="pb-3 px-2">Platform</th>
                <th class="pb-3 px-2">Link</th>
                <th class="pb-3 px-2">Thời gian</th>
                <th class="pb-3 px-2 text-right">Xóa</th>
              </tr>
              </thead>

              <tbody class="divide-y divide-gray-50">
              <tr v-for="post in filteredPosts" :key="post.id" class="hover:bg-blue-50/30 transition">
                <td class="py-4 px-2 font-bold text-gray-700 text-sm">{{ post.user }}</td>
                <td class="py-4 px-2">
                  <span :class="getPlatformColor(post.platform)"
                        class="px-2 py-0.5 rounded text-[10px] font-black text-white">
                    {{ post.platform }}
                  </span>
                </td>
                <td class="py-4 px-2">
                  <a :href="post.link" target="_blank"
                     class="text-blue-500 hover:underline flex items-center gap-1 text-xs">
                    Link
                    <i data-lucide="external-link" class="w-3 h-3"></i>
                  </a>
                </td>
                <td class="py-4 px-2 text-gray-400 text-[10px]">{{ formatTime(post.timestamp) }}</td>
                <td class="py-4 px-2 text-right">
                  <button @click="deletePost(post.id)" class="text-red-400 hover:text-red-600 transition p-1">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                  </button>
                </td>
              </tr>
              </tbody>
            </table>
          </div>

        </div>

      </div>
    </div>
  </main>

  <!-- ANNOUNCEMENT MODAL (SHOW ON LOAD, FROM FIREBASE) -->
  <div v-if="showAnnouncement" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[120] p-4">
    <div class="bg-white rounded-3xl p-7 max-w-lg w-full shadow-2xl animate-in zoom-in duration-300 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-blue-600"></div>

      <div class="flex items-start gap-3">
        <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-700 flex items-center justify-center shrink-0">
          <i data-lucide="bell-ring" class="w-6 h-6"></i>
        </div>

        <div class="min-w-0">
          <h3 class="text-lg font-black text-gray-800">
            {{ announcement.title || 'Thông báo từ Admin' }}
          </h3>
          <p v-if="announcement.updatedAt" class="text-[11px] text-gray-400 mt-1">
            Cập nhật: <span class="font-bold text-gray-600">{{ formatTime(announcement.updatedAt) }}</span>
          </p>
        </div>
      </div>

      <div class="mt-4 text-sm text-gray-700 whitespace-pre-line bg-gray-50 border border-gray-200 rounded-2xl p-4">
        {{ announcement.content || 'Chưa có nội dung thông báo.' }}
      </div>

      <div class="mt-6 flex gap-2">
        <button
          @click="closeAnnouncement"
          class="flex-1 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition"
        >
          Đã hiểu
        </button>
        <button
          @click="closeAnnouncement(true)"
          class="py-3 px-4 bg-gray-100 text-gray-600 font-black rounded-xl hover:bg-gray-200 transition"
          title="Không hiện lại cho thông báo này"
        >
          Ẩn
        </button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div v-if="showLogin" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300">
      <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
        <i data-lucide="lock" class="w-8 h-8"></i>
      </div>
      <h3 class="text-xl font-bold text-center mb-2">Quyền truy cập Admin</h3>
      <p class="text-gray-500 text-center text-sm mb-6">Nhập mật khẩu để xem thống kê</p>

      <input v-model="adminPass" type="password" placeholder="Mật khẩu..."
             class="w-full px-4 py-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500 text-center" />

      <div class="flex gap-2">
        <button @click="showLogin = false"
                class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">
          Hủy
        </button>
        <button @click="loginAdmin"
                class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition">
          Xác nhận
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC-rfJLLy8eD11Ett1MNcsXTnean497Tbk",
    authDomain: "social-post-reporting.firebaseapp.com",
    projectId: "social-post-reporting",
    storageBucket: "social-post-reporting.firebasestorage.app",
    messagingSenderId: "600995142287",
    appId: "1:600995142287:web:2d74db66d825520e1b6efa",
    measurementId: "G-V106CQTG0F",
    databaseURL: "https://social-post-reporting-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };

  try { firebase.initializeApp(firebaseConfig); } catch(e) {}

  const db = firebase.database().ref('posts');
  const dbSales = firebase.database().ref('sales');

  // NEW: announcement node
  const dbAnnouncement = firebase.database().ref('announcement');

  const { createApp, ref, onMounted, computed, watch, nextTick } = Vue;

  createApp({
    setup() {
      const currentTab = ref('report');
      const posts = ref([]);
      const loading = ref(false);
      const isAdmin = ref(false);
      const showLogin = ref(false);
      const adminPass = ref('');
      const form = ref({ user: '', platform: 'Facebook', link: '' });

      let chart = null;

      // ===== SELL-OUT STATE =====
      const sales = ref([]);
      const saleLoading = ref(false);
      const saleForm = ref({ user: '', team: 'Sale', item: '', qty: 1, revenue: 0, channel: 'Online' });
      const topN = ref(10);
      let selloutChart = null;

      // ===== EMPLOYEE NAME MEMORY =====
      const EMPLOYEE_KEY = 'mediahub_employee_names_v1';
      const LAST_REPORT_KEY = 'mediahub_last_report_user_v1';
      const LAST_SELLOUT_KEY = 'mediahub_last_sellout_user_v1';

      const employeeNames = ref([]);

      const reportUserSelected = ref('');
      const reportUserNew = ref('');

      const selloutUserSelected = ref('');
      const selloutUserNew = ref('');

      const normalizeName = (name) => (name || '').trim().replace(/\s+/g, ' ');

      const loadEmployeeNames = () => {
        try {
          const raw = localStorage.getItem(EMPLOYEE_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          employeeNames.value = Array.isArray(arr) ? arr : [];
        } catch {
          employeeNames.value = [];
        }
      };

      const saveEmployeeNames = () => {
        localStorage.setItem(EMPLOYEE_KEY, JSON.stringify(employeeNames.value));
      };

      const upsertName = (name) => {
        const n = normalizeName(name);
        if (!n) return '';
        const exists = employeeNames.value.some(x => x.toLowerCase() === n.toLowerCase());
        if (!exists) {
          employeeNames.value.unshift(n);
          employeeNames.value = employeeNames.value.slice(0, 200);
          saveEmployeeNames();
        }
        return n;
      };

      const commitNewName = (context) => {
        if (context === 'report') {
          const n = upsertName(reportUserNew.value);
          if (n) {
            reportUserSelected.value = n;
            reportUserNew.value = '';
            form.value.user = n;
            localStorage.setItem(LAST_REPORT_KEY, n);
          }
        } else {
          const n = upsertName(selloutUserNew.value);
          if (n) {
            selloutUserSelected.value = n;
            selloutUserNew.value = '';
            saleForm.value.user = n;
            localStorage.setItem(LAST_SELLOUT_KEY, n);
          }
        }
      };

      watch(reportUserSelected, (val) => {
        if (val && val !== '__new__') {
          form.value.user = val;
          localStorage.setItem(LAST_REPORT_KEY, val);
          upsertName(val);
        } else if (val === '__new__') {
          form.value.user = '';
        }
      });

      watch(selloutUserSelected, (val) => {
        if (val && val !== '__new__') {
          saleForm.value.user = val;
          localStorage.setItem(LAST_SELLOUT_KEY, val);
          upsertName(val);
        } else if (val === '__new__') {
          saleForm.value.user = '';
        }
      });

      // ===== ADMIN SEARCH BY USER =====
      const searchUser = ref('');

      const stripVN = (str) => (str || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/Đ/g, 'D')
        .toLowerCase()
        .trim();

      const filteredPosts = computed(() => {
        const q = stripVN(searchUser.value);
        if (!q) return posts.value;
        return posts.value.filter(p => stripVN(p.user).includes(q));
      });

      // ===== NEW: ANNOUNCEMENT SYSTEM =====
      const ANNOUNCE_SEEN_KEY = 'mediahub_announcement_seen_v1';

      const announcement = ref({
        enabled: false,
        title: '',
        content: '',
        updatedAt: 0
      });

      const announceEdit = ref({
        enabled: false,
        title: '',
        content: ''
      });

      const showAnnouncement = ref(false);
      const announceSaving = ref(false);

      const shouldAutoShowAnnouncement = (a) => {
        if (!a || !a.enabled) return false;
        const updatedAt = Number(a.updatedAt || 0);
        if (!updatedAt) return false;

        const seen = Number(localStorage.getItem(ANNOUNCE_SEEN_KEY) || 0);
        return updatedAt > seen;
      };

      const closeAnnouncement = (silent = false) => {
        // mark seen for this announcement version
        const updatedAt = Number(announcement.value.updatedAt || 0);
        if (updatedAt) localStorage.setItem(ANNOUNCE_SEEN_KEY, String(updatedAt));
        showAnnouncement.value = false;
        if (!silent) setTimeout(() => lucide.createIcons(), 50);
      };

      const resetAnnounceEdit = () => {
        announceEdit.value = {
          enabled: !!announcement.value.enabled,
          title: announcement.value.title || '',
          content: announcement.value.content || ''
        };
        setTimeout(() => lucide.createIcons(), 50);
      };

      const forceShowAnnouncement = () => {
        // show preview based on current edit, not necessarily saved
        announcement.value = {
          enabled: !!announceEdit.value.enabled,
          title: announceEdit.value.title || '',
          content: announceEdit.value.content || '',
          updatedAt: announcement.value.updatedAt || Date.now()
        };
        showAnnouncement.value = true;
        setTimeout(() => lucide.createIcons(), 50);
      };

      const loadAnnouncement = () => {
        dbAnnouncement.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && typeof data === 'object') {
            announcement.value = {
              enabled: !!data.enabled,
              title: data.title || '',
              content: data.content || '',
              updatedAt: Number(data.updatedAt || 0)
            };
          } else {
            announcement.value = { enabled: false, title: '', content: '', updatedAt: 0 };
          }

          // sync edit form if empty (or first time)
          if (!announceEdit.value.title && !announceEdit.value.content) {
            resetAnnounceEdit();
          }

          // auto-show on load if new
          if (shouldAutoShowAnnouncement(announcement.value)) {
            showAnnouncement.value = true;
          }

          setTimeout(() => lucide.createIcons(), 50);
        });
      };

      const saveAnnouncement = async () => {
        announceSaving.value = true;
        try {
          const payload = {
            enabled: !!announceEdit.value.enabled,
            title: (announceEdit.value.title || '').trim(),
            content: (announceEdit.value.content || '').trim(),
            updatedAt: Date.now()
          };
          await dbAnnouncement.set(payload);

          // (Optional) after saving, you can also force modal show next time by clearing seen:
          // localStorage.removeItem(ANNOUNCE_SEEN_KEY);

          alert('Đã lưu thông báo! Người dùng sẽ thấy khi vào web (thông báo mới).');
        } catch (e) {
          alert('Lỗi lưu thông báo: ' + (e && e.message ? e.message : e));
        } finally {
          announceSaving.value = false;
          setTimeout(() => lucide.createIcons(), 50);
        }
      };

      // ===== LOAD POSTS =====
      const loadData = () => {
        db.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            posts.value = Object.keys(data).map(key => ({
              id: key,
              ...data[key]
            })).reverse();
          } else {
            posts.value = [];
          }

          if (isAdmin.value && currentTab.value === 'admin') {
            setTimeout(() => { initChart(); lucide.createIcons(); }, 100);
          }
        });
      };

      // ===== LOAD SALES =====
      const loadSales = () => {
        dbSales.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            sales.value = Object.keys(data).map(key => ({
              id: key,
              ...data[key]
            })).reverse();
          } else {
            sales.value = [];
          }

          if (currentTab.value === 'sellout') {
            setTimeout(() => { initSelloutChart(); lucide.createIcons(); }, 100);
          }
        });
      };

      // ===== SUBMIT REPORT =====
      const submitReport = async () => {
        if (reportUserSelected.value === '__new__') commitNewName('report');

        const userName = normalizeName(form.value.user);
        if (!userName) {
          alert('Vui lòng chọn hoặc nhập Họ tên nhân viên.');
          return;
        }
        form.value.user = userName;
        upsertName(userName);
        localStorage.setItem(LAST_REPORT_KEY, userName);

        loading.value = true;
        try {
          const newPost = { ...form.value, timestamp: new Date().getTime() };
          await db.push(newPost);
          alert('Báo cáo đã được ghi lại thành công!');
          form.value = { user: userName, platform: 'Facebook', link: '' };
          reportUserSelected.value = userName;
        } catch (error) {
          alert('Lỗi: ' + error.message);
        } finally {
          loading.value = false;
        }
      };

      // ===== DELETE POST =====
      const deletePost = async (id) => {
        if (confirm('Bạn có chắc chắn muốn xóa báo cáo này?')) {
          try {
            await db.child(id).remove();
          } catch (error) {
            alert('Không thể xóa: ' + error.message);
          }
        }
      };

      // ===== SUBMIT SALE =====
      const submitSale = async () => {
        if (selloutUserSelected.value === '__new__') commitNewName('sellout');

        const userName = normalizeName(saleForm.value.user);
        if (!userName) {
          alert('Vui lòng chọn hoặc nhập Họ tên nhân viên.');
          return;
        }
        saleForm.value.user = userName;
        upsertName(userName);
        localStorage.setItem(LAST_SELLOUT_KEY, userName);

        saleLoading.value = true;
        try {
          const payload = {
            ...saleForm.value,
            qty: Number(saleForm.value.qty || 0),
            revenue: Number(saleForm.value.revenue || 0),
            timestamp: new Date().getTime(),
          };
          await dbSales.push(payload);
          alert('Sell-out đã được ghi lại!');
          saleForm.value = { user: userName, team: 'Sale', item: '', qty: 1, revenue: 0, channel: 'Online' };
          selloutUserSelected.value = userName;
        } catch (error) {
          alert('Lỗi: ' + error.message);
        } finally {
          saleLoading.value = false;
        }
      };

      // ===== DELETE SALE =====
      const deleteSale = async (id) => {
        if (confirm('Bạn có chắc chắn muốn xóa sell-out này?')) {
          try {
            await dbSales.child(id).remove();
          } catch (error) {
            alert('Không thể xóa: ' + error.message);
          }
        }
      };

      // ===== ADMIN ACCESS =====
      const checkAdminAccess = () => {
        if (isAdmin.value) currentTab.value = 'admin';
        else showLogin.value = true;
      };

      const loginAdmin = () => {
        if (adminPass.value === 'admin123') {
          isAdmin.value = true;
          showLogin.value = false;
          currentTab.value = 'admin';
          // load current announcement into editor when admin logs in
          resetAnnounceEdit();
          setTimeout(() => lucide.createIcons(), 50);
        } else {
          alert('Sai mật khẩu!');
        }
      };

      // ===== WATCH TAB =====
      watch(currentTab, async (newTab) => {
        if (newTab === 'admin' && isAdmin.value) {
          await nextTick();
          initChart();
          resetAnnounceEdit();
          lucide.createIcons();
        } else if (newTab === 'sellout') {
          await nextTick();
          initSelloutChart();
          lucide.createIcons();
        } else {
          await nextTick();
          lucide.createIcons();
        }
      });

      // ===== STATS =====
      const stats = computed(() => [
        { label: 'Tổng bài đăng', value: posts.value.length },
        { label: 'Facebook', value: posts.value.filter(p => p.platform === 'Facebook').length },
        { label: 'TikTok', value: posts.value.filter(p => p.platform === 'TikTok').length },
        { label: 'Khác', value: posts.value.filter(p => !['Facebook', 'TikTok'].includes(p.platform)).length },
      ]);

      // ===== HELPERS =====
      const formatTime = (ts) => new Date(ts).toLocaleString('vi-VN');
      const getPlatformColor = (p) => {
        const colors = { 'Facebook': 'bg-blue-600', 'TikTok': 'bg-black', 'Instagram': 'bg-pink-600', 'YouTube': 'bg-red-600' };
        return colors[p] || 'bg-gray-500';
      };

      // ===== CHART =====
      const initChart = () => {
        const ctx = document.getElementById('platformChart');
        if (!ctx) return;
        const dataMap = posts.value.reduce((acc, p) => {
          acc[p.platform] = (acc[p.platform] || 0) + 1;
          return acc;
        }, {});
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(dataMap),
            datasets: [{ data: Object.values(dataMap), backgroundColor: ['#2563eb', '#000000', '#db2777', '#dc2626'] }]
          },
          options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      };

      // ===== EXPORT CSV =====
      const exportToCSV = () => {
        let csv = 'User,Platform,Link,Timestamp\n';
        posts.value.forEach(p => csv += `${p.user},${p.platform},${p.link},${formatTime(p.timestamp)}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'report_media.csv');
        a.click();
      };

      // ===== SELL-OUT COMPUTED =====
      const totalRevenue = computed(() =>
        sales.value.reduce((sum, s) => sum + (Number(s.revenue) || 0), 0)
      );

      const totalQty = computed(() =>
        sales.value.reduce((sum, s) => sum + (Number(s.qty) || 0), 0)
      );

      const ranking = computed(() => {
        const map = new Map();
        for (const s of sales.value) {
          const user = (s.user || '').trim();
          if (!user) continue;
          const team = (s.team || '-').trim() || '-';
          const key = `${user}__${team}`;
          if (!map.has(key)) map.set(key, { user, team, qty: 0, revenue: 0 });
          const item = map.get(key);
          item.qty += Number(s.qty) || 0;
          item.revenue += Number(s.revenue) || 0;
        }

        return Array.from(map.values())
          .sort((a, b) => b.revenue - a.revenue)
          .slice(0, Number(topN.value) || 10);
      });

      const formatVND = (v) => {
        const n = Number(v || 0);
        return n.toLocaleString('vi-VN') + ' ₫';
      };

      // ===== SELL-OUT CHART =====
      const initSelloutChart = () => {
        const ctx = document.getElementById('selloutChart');
        if (!ctx) return;

        const labels = ranking.value.map(r => r.user);
        const data = ranking.value.map(r => r.revenue);

        if (selloutChart) selloutChart.destroy();
        selloutChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'Doanh thu (VNĐ)', data }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                ticks: {
                  callback: (value) => Number(value).toLocaleString('vi-VN')
                }
              }
            }
          }
        });
      };

      // ===== EXPORT SELL-OUT CSV =====
      const exportSelloutToCSV = () => {
        let csv = 'User,Team,Item,Qty,Revenue,Channel,Timestamp\n';
        sales.value.forEach(s => {
          csv += `${(s.user || '')},${(s.team || '')},${(s.item || '')},${Number(s.qty || 0)},${Number(s.revenue || 0)},${(s.channel || '')},${formatTime(s.timestamp)}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'sellout.csv');
        a.click();
      };

      // ===== INIT =====
      onMounted(() => {
        loadEmployeeNames();

        const lastReport = localStorage.getItem(LAST_REPORT_KEY) || '';
        const lastSellout = localStorage.getItem(LAST_SELLOUT_KEY) || '';

        if (lastReport) {
          reportUserSelected.value = lastReport;
          form.value.user = lastReport;
          upsertName(lastReport);
        } else if (employeeNames.value.length) {
          reportUserSelected.value = employeeNames.value[0];
          form.value.user = employeeNames.value[0];
        }

        if (lastSellout) {
          selloutUserSelected.value = lastSellout;
          saleForm.value.user = lastSellout;
          upsertName(lastSellout);
        } else if (employeeNames.value.length) {
          selloutUserSelected.value = employeeNames.value[0];
          saleForm.value.user = employeeNames.value[0];
        }

        loadData();
        loadSales();

        // NEW: load announcement + auto show if new
        loadAnnouncement();

        lucide.createIcons();
      });

      return {
        // original
        currentTab, form, posts, loading, isAdmin, showLogin, adminPass,
        stats, submitReport, deletePost, checkAdminAccess, loginAdmin,
        formatTime, getPlatformColor, exportToCSV,

        // admin search
        searchUser, filteredPosts,

        // sell-out
        sales, saleForm, saleLoading, submitSale, deleteSale,
        ranking, topN, totalRevenue, totalQty, formatVND, exportSelloutToCSV,

        // employee memory
        employeeNames,
        reportUserSelected, reportUserNew,
        selloutUserSelected, selloutUserNew,
        commitNewName,

        // announcement
        announcement,
        announceEdit,
        showAnnouncement,
        closeAnnouncement,
        saveAnnouncement,
        resetAnnounceEdit,
        forceShowAnnouncement,
        announceSaving
      };
    }
  }).mount('#app');
</script>
</body>
</html>
